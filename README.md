<div align="center">
    <h1>👫 YBR - Couple Application #Prototype</h1>
</div>

<div align="left">

## :bookmark_tabs: 목차
- 🔗 [링크](#-링크)
- 💏 [프로젝트설명](#-프로젝트-설명)
- 📜 [미리보기](#-미리보기)
- 🛠 [기술 스택](#-기술-스택)
- ⚡ [서버 실행](#-서버-실행)
- 📁 [ERD](#-erd)
- 🔀 [시스템 흐름도](#-시스템-흐름도)
- ⭐ [기능 소개](#-기능-소개)

## **🔗 링크**
### 1️⃣ &nbsp; 사용자 페이지 - <a href="https://ybr.pritras.com" target="_blank">바로가기</a>
### 2️⃣ &nbsp; Swagger - <a href="https://ybr.pritras.com/api-docs" target="_blank">바로가기</a>

## **✨ 프로젝트 설명**
```
커플 간의 관계를 향상시키고 일상 생활을 보다 효율적으로 관리하는 데 도음을 주는 웹 애플리케이션입니다.
4가지 핵심 기능을 통해 다음과 같은 장점을 가집니다.
1. 캘린더 기능을 통해 일정을 조율하고 협업할 수 있습니다.
2. 채팅 기능을 통해 즉각적인 소통을 가능하게 합니다.
3. 앨범 기능을 통해 추억을 공유할 수 있습니다.
4. 프로필 기능을 통해 커플만이 가지는 개성을 표현할 수 있습니다.
```

## **🔍 미리보기**

<details>
    <summary><h3>로그인 페이지</h3></summary>
    <table>
        <tr>
            <td>
                <kbd>
                    <img src="https://github.com/primero-pjh/ybr/assets/58695375/5ff903e6-0467-4192-8178-be7a05dfc9e7" />   
                </kbd>
            </td>
            <td >
                <div>
                    <h3>📃 설명</h3>
                </div>
                <div>
                    :one: &nbsp;YBR 서비스를 이용하기 위한 로그인 페이지 입니다.
                    <br>
                    :two: 일반 로그인과 카카오 로그인을 제공합니다.
                    <br>
                    :three: 회원가입을 통해 서비스를 이용할 수 있습니다.   
                </div>
            </td>
        </tr>
    </table>
</details>
<details>
    <summary><h3>홈 페이지</h3></summary>
    <table>
        <tr>
            <td>
                <kbd>
                    <img src="https://github.com/primero-pjh/ybr/assets/58695375/39999459-1de2-4e34-8f98-9535b5c7fd84" />        
                </kbd>
            </td>
            <td>
                <div>
                    <h3>📃 설명</h3>
                </div>
                <div>
                    :one: YBR 서비스의 기본이 되는 Index 페이지입니다.
                    <br>
                    :two: 커플과 함께 꾸민 배경사진을 볼 수 있습니다.
                    <br>
                    :three: 등록한 일정을 쉽게 찾아볼 수 있습니다.
                    <br>
                    :four: 등록한 앨범을 볼 수 있습니다.
                </div>
            </td>
        </tr>
    </table>
</details>
<details>
    <summary><h3>캘린더 페이지</h3></summary>
    <table>
        <tr>
            <td>
                <kbd>
                    <img src="https://github.com/primero-pjh/ybr/assets/58695375/dc7d1d16-50d2-4728-a63a-ff753420217f" />        
                </kbd>
            </td>
            <td>
                <div>
                    <h3>📃 설명</h3>
                </div>
                <div>
                    :one: YBR 서비스에서 제공하는 캘린더 페이지입니다.
                    <br>
                    :two: 커플과 함께 일정을 등록, 수정 및 삭제 할 수 있는 페이지입니다.
                    <br>
                    :three: 일정을 유형별로 볼 수 있는 캘린더 필터 기능을 제공합니다.
                    <br>
                    :four: 월간, 주간, 일간 단위로 조회가 가능합니다.
                </div>
            </td>
        </tr>
    </table>
</details>
<details>
    <summary><h3>채팅 페이지</h3></summary>
    <table>
        <tr>
            <td>
                <kbd>
                    <img src="https://github.com/primero-pjh/ybr/assets/58695375/caf433c0-c592-4492-96f6-f1e821e94068" />
                </kbd>
            </td>
            <td>
                <div>
                    <h3>📃 설명</h3>
                </div>
                <div>
                    :one: YBR 서비스에서 제공하는 채팅 페이지입니다.
                    <br>
                    :two: 커플과 즉각적인 소통을 가능하게 합니다.
                    <br>
                </div>
            </td>
        </tr>
    </table>
</details>
<details>
    <summary><h3>앨범 페이지</h3></summary>
    <table>
        <tr>
            <td>
                <kbd>
                    <img src="https://github.com/primero-pjh/ybr/assets/58695375/3a66e4a3-f3b8-4803-ade9-159d2127a7d0" />
                </kbd>
            </td>
            <td>
                <div>
                    <h3>📃 설명</h3>
                </div>
                <div>
                    :one: YBR 서비스에서 제공하는 앨범 페이지입니다.
                    <br>
                    :two: 우측 하단의 Fab Button을 통해 앨범을 추가할 수 있습니다.
                    <br>
                    :three: 등록한 앨범을 조회하고, 수정할 수 있습니다.
                </div>
            </td>
        </tr>
    </table>
</details>
<details>
    <summary><h3>프로필 페이지</h3></summary>
    <table>
        <tr>
            <td>
                <kbd>
                    <img src="https://github.com/primero-pjh/ybr/assets/58695375/64abace4-c92f-42c7-bee3-d036aeed681d" />
                </kbd>
            </td>
            <td>
                <div>
                    <h3>📃 설명</h3>
                </div>
                <div>
                    :one: YBR 서비스에서 제공하는 프로필 페이지입니다.
                    <br>
                    :two: 좌측 Layer으로 각 Components를 드래그하여 아이템들을 배치할 수 있습니다.
                    <br>
                    :three: 우측 Layer에 Tools로 배경이미지를 삽입하거나, 텍스트를 배치할 수 있고 미리볼 수 있습니다.
                    <br>
                </div>
            </td>
        </tr>
    </table>
</details>

## **🛠 기술 스택**

### **:one: Language**
<img src="https://img.shields.io/badge/nodejs-339933?style=for-the-badge&logo=nodedotjs&logoColor=white">
<img src="https://img.shields.io/badge/javascript-F7DF1E?style=for-the-badge&logo=javascript&logoColor=white"> 
<img src="https://img.shields.io/badge/html5-E34F26?style=for-the-badge&logo=html5&logoColor=white"> 
<br>

### **:two: FE - Frameworks**
<img src="https://img.shields.io/badge/Vue-4FC08D?style=for-the-badge&logo=Vue.js&logoColor=white"> 
<img src="https://img.shields.io/badge/Quasar-050A14?style=for-the-badge&logo=Quasar&logoColor=white">
<img src="https://img.shields.io/badge/SocketIO-010101?style=for-the-badge&logo=socketdotio&logoColor=white">
<img src="https://img.shields.io/badge/AXIOS-5A29E4?style=for-the-badge&logo=axios&logoColor=white">
<img src="https://img.shields.io/badge/Toast-000000?style=for-the-badge&logo=&logoColor=white">
<br>

### **:three: BE - Frameworks**
<img src="https://img.shields.io/badge/Express-000000?style=for-the-badge&logo=express&logoColor=white">
<img src="https://img.shields.io/badge/JWT-000000?style=for-the-badge&logo=&logoColor=white">    
<img src="https://img.shields.io/badge/MySQL-4479A1?style=for-the-badge&logo=MySQL&logoColor=white">
<br>
<img src="https://img.shields.io/badge/Linux-FCC624?style=for-the-badge&logo=linux&logoColor=white"> 
<img src="https://img.shields.io/badge/nginx-009639?style=for-the-badge&logo=nginx&logoColor=white"> 
<img src="https://img.shields.io/badge/letsencrypt-003A70?style=for-the-badge&logo=letsencrypt&logoColor=white"> 
<br>
<img src="https://img.shields.io/badge/swagger-85EA2D?style=for-the-badge&logo=swagger&logoColor=white">
<img src="https://img.shields.io/badge/github-181717?style=for-the-badge&logo=github&logoColor=white">
<br>

### **:four: RESTAPI**
<img src="https://img.shields.io/badge/kakao-FFCD00?style=for-the-badge&logo=kakao&logoColor=white">
<img src="https://img.shields.io/badge/naver-03C75A?style=for-the-badge&logo=naver&logoColor=white">
<br>

### **:five: API Document**
<img src="https://img.shields.io/badge/swagger-85EA2D?style=for-the-badge&logo=swagger&logoColor=white">
</div>

## **⚡ 서버 실행**

### 1. 개발서버 
```
$ npm run build-dev // Frontend 데이터를 Backend로 build 합니다.
$ npm run start     // Backend 실행
```
### 2. 리얼서버
```
$ npm run build     // Frontend 데이터를 Backend로 build 합니다.
$ npm start         // Backend 실행
```
    
## **📦 ERD**
<kbd>
    <img src="https://github.com/primero-pjh/ybr/assets/58695375/6fb45a06-23bf-459f-932a-fb81a1da2939" />
</kbd>

## **🔀 시스템 흐름도**
<kbd>
    <img src="https://github.com/primero-pjh/ybr/assets/58695375/6e8569f9-f1ff-4f47-96e0-7495e6342767" />
</kbd>

<details>
    <summary><h3>상세 설명</h3></summary>

    1. 클라이언트는 YBR에서 제공하는 FE(Vue)를 통해 커플 웹 서비스를 이용할 수 있습니다.
    2. 서버는 Node-Express-Framework를 사용하여 모든 요청을 응답합니다.
    3. 올바른 사용자 검증을 위해 모든 Rest-API 요청에 JWT Token을 포함하여 전송합니다.
    4. 서버는 모든 요청의 JWT Token을 검증합니다. 
    5. 올바른 요청에서의 데이터를 조회하고 저장하며 사용자의 요청을 성공, 실패를 반환합니다.
</details>

## ⭐ 기능 소개

### **:one: MVC 패턴과 디렉토리 구조**
<kbd><img src="https://github.com/primero-pjh/ybr/assets/58695375/0b865988-f9ad-44eb-b689-7f1aaa036a20" width="30%" /><img src="https://github.com/primero-pjh/ybr/assets/58695375/7a28f15a-b882-4979-bdeb-6d851c59d202" /></kbd>

<b>YBR 프로젝트는 MVC 패턴을 따라 디렉토리 구조를 설계하였습니다.</b><br>    
<b>M</b>odel - NodeJs 특성상 자료형이 자유롭기 때문에 생략하였습니다.<br>
<b>V</b>iew - /ybr/backend/public/index.html<br>
- /ybr/frontend의 파일들이 build가 되며 /ybr/backend/public으로 들어오게 됩니다. :arrow_forward: 📌 [코드 보기](https://github.com/primero-pjh/ybr/blob/master/frontend/vue.config.js)
- YBR의 Client에게 제공되는 UI/UX입니다.
  
<br>

<b>C</b>ontroller - /ybr/backend/routes
- 사용자의 요청에 따라 응답하게 되는 Controller(Router) 디렉토리입니다.
- axios: /ybr/backend/routes/api
- socket-io: /ybr/backend/routes/socket



### **:two: 통신 규약**

### **🔎 Axios : 서버와 통신을 위해 사용되는 Promise 기반 HTTP 비동기 통신 라이브러리**
1. Server에 요청하기 전에 Headers에 Token(JWT)를 첨부하여 서버에 요청합니다.
```javascript
axios.interceptors.request.use((config) => {
    let token = $c.getCookie('token'); // Browser-Cookie에 저장된 token을 가져온다.
    config.headers["Authorization"] = token;
    return config;
}, (error) => {
    return Promise.reject(error);
});
```
2. 서버에서 응답을 받고, 각 페이지에 응답되기 전에 에러가 있다면 분기문을 통해 처리합니다.
```javascript
axios.interceptors.response.use((res) => {
    let data = res.data;
    if(data.success == 0 && Object.prototype.hasOwnProperty.call(data, "isLogged")) { // Jwt 토큰 검증에 실패한 경우 에러코드 출력 후 Login 페이지로 이동
        alert(data.message);
        window.location = "/#/login";
    } else if (data.success == 0 && Object.prototype.hasOwnProperty.call(data, "code")) { // couple의 정보가 잘못된 경우 에러코드 출력 후 Login 페이지로 이동
        if(data.code == "COUPLE_EMPTY_ERROR") {
            alert(data.message);
            window.location = "/#/login";
        }
    }
    return res;
}, (error) => {
    return Promise.reject(error);
});
```
3. 서버의 <b>Middleware</b> 코드→ 사용자가 요청한 end-point로 도달하기 전에 Header에 담겨진 JWT-Token의 유효성을 검사를 합니다.
```javascript
app.all('/api/*', async (req, res, next) => {
    let url = req.url;
    res.header("Access-Control-Allow-Origin", "*");
    res.header("Access-Control-Allow-Headers", "X-Requested-With"); 
    /* 
        url의 요청이 login이 아니라면
        사용자가 추가한 authorization의 jwt token 값의 유효성을 검사한다.
    */
    if(url != '/api/user/login') {
        let token = req.headers.authorization;
        let resJwt = await jwtFunc.verify(token);
        if(!resJwt) {
            return res.json({
                success: 0,
                isLogged: false,
                message: CRT_ERROR_CODE["LOGIN_TOKEN"],
            });
        }
        req.self = resJwt;  // 에러가 없는 경우 req 인자에 self 필드를 추가합니다.
    }
    next(); // 사용자가 요청한 end-point로 전송합니다.
});
```

### **🔎 Socket.IO : 웹 소켓 연결을 통해 클라이언트와 서버간에 실시간 양방향 통신을 가능하게 하는 라이브러리**

1. 로그인 성공 후 handshake-auth에 JWT-Token을 포함하여 socket에 연결하는 코드
```javascript
const socket = io(`${vm.$store.state.host}`, {
    auth: { token, },
});
```
2. 서버의 <b>Middleware</b> 코드→ 사용자가 요청한 end-point로 도달하기 전에 Header에 담겨진 JWT-Token의 유효성을 검사를 합니다.
```javascript
io.use((socket, next) => {
let token = socket.handshake.auth.token;
    if(token) {
        jwtFunc.verify(token).then((res) => {
            if(!res) {
                socket.emit('/error', {
                    message: '로그인 토큰 만료!\n'
                });
            }
        });
        next(); // 이상이 없는 경우 end-point로 이동한다.
    } else {
        console.error('\u001b[41m', 'jwt token error', '\x1b[40m');
        socket.emit('/error', {
            message: '로그인 토큰 만료!\n'
        });
        next(); // 잘못된 데이터로 error를 반환한다.
    }
});
```

### **:three: 배포 자동화**
### **🔎 Crontab을 이용한 배포 자동화 서비스**
1. 매일 새벽 1시에 sh 파일을 실행하고 log 기록
```sh
0 1 * * * /var/www/html/cron/running_ybr.sh >> /var/www/html/cron/running_ybr.log 2>&1
```
2. running_ybr.sh code
```sh
cd /var/www/html/ybr/backend      # director로 이동
git pull origin master            # git에 올려진 파일을 다운로드 받음
npm install                       # library 설치
sudo forever stopall              # 동작되고 있는 모든 서버 종료
sudo forever start ./bin/www      # 서버 시작
```

